name: SmallAmp
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  reponame: ${{github.event.repository.name}}
  project_baseline: Roassal3 # I'm important. change me in each repo
  project_directory: src
  iteration: 3
  maxInputs: 10
  mode: dspotFast

on:
  workflow_dispatch:
    inputs:
      testClasses:
        description: 'TestClasses to amplify (comma separated) empty-> all'
        required: false
        default: ''
      parallel_jobs:         
        description: 'Number of all parallel jobs'
        required: true
        default: '8'
jobs:
  MatrixBuild:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        env:
          parallel_jobs: ${{ github.event.inputs.parallel_jobs }}
        run: |
          matrix=$(python -c "import json;print(json.dumps({'jobs':[{'a':x} for x in range($parallel_jobs)]}))")
          echo "::set-output name=matrix::$matrix"

  TestAmplification: 
    needs: MatrixBuild
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJSON(needs.MatrixBuild.outputs.matrix)}}
#        portion: [1 , 2, 3, 4, 5, 6, 7, 8] # Change me if you like to run in parallel. The content of array is not important, just the length
    name: Job number ${{ strategy.job-index }}
    steps:
      - uses: actions/checkout@v2
        with:
           fetch-depth: 0
      - uses: mabdi/smallamp-action@main
        with:
          action: setup
      - uses: mabdi/smallamp-action@main
        with:
          action: amplify
        env:
          SMALLAMP_PORTION: ${{ strategy.job-index }} 
          SMALLAMP_ALLJOBS: ${{ strategy.job-total }}
          SMALLAMP_iteration: ${{ env.iteration }}
          SMALLAMP_maxInputs: ${{ env.maxInputs }}
          SMALLAMP_mode: ${{ env.mode }}  
          SMALLAMP_testClasses: ${{ github.event.inputs.testClasses }}

  TestAmplificationPush:
    runs-on: ubuntu-latest
    needs: TestAmplification
    steps:
      - uses: actions/checkout@v2
        with:
           fetch-depth: 0
      - uses: mabdi/smallamp-action@main
        with:
          action: setup
      - name: Download artifacts
        uses: actions/download-artifact@v2
        with:
          path: ${{ env.PHARO_HOME }}
      - uses: mabdi/smallamp-action@main
        with:
          action: push
          github-token: ${{secrets.GITHUB_TOKEN}}
          
